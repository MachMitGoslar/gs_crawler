name: Container Instances - Build Test

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docker_instances/**'
      - 'base_images/**'
      - '.github/workflows/container-instances-test.yml'
  workflow_dispatch:  # Allow manual triggering

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed-containers: ${{ steps.changes.outputs.changed-containers }}
      all-containers: ${{ steps.containers.outputs.all-containers }}
      base-images-changed: ${{ steps.changes.outputs.base-images-changed }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Detect changed files
      id: changes
      run: |
        echo "ðŸ” Detecting changed containers and base images..."
        
        # Erkenne geÃ¤nderte Container
        changed_files=$(git diff --name-only HEAD~1 HEAD)
        changed_containers=()
        base_images_changed="false"
        
        # PrÃ¼fe auf Base-Image-Ã„nderungen
        if echo "$changed_files" | grep -q "^base_images/"; then
          base_images_changed="true"
          echo "ðŸ”„ Base images changed - will test all containers"
        fi
        
        # Sammle geÃ¤nderte Container
        for file in $changed_files; do
          if [[ $file == docker_instances/*/Dockerfile ]] || [[ $file == docker_instances/*/*.py ]] || [[ $file == docker_instances/*/*.php ]] || [[ $file == docker_instances/*/crontab ]]; then
            container=$(echo $file | cut -d'/' -f2)
            if [[ ! " ${changed_containers[@]} " =~ " ${container} " ]]; then
              changed_containers+=("$container")
            fi
          fi
        done
        
        # Ausgabe als JSON Array
        if [ ${#changed_containers[@]} -eq 0 ] && [ "$base_images_changed" == "false" ]; then
          echo "changed-containers=[]" >> $GITHUB_OUTPUT
        else
          printf -v joined '"%s",' "${changed_containers[@]}"
          echo "changed-containers=[${joined%,}]" >> $GITHUB_OUTPUT
        fi
        
        echo "base-images-changed=$base_images_changed" >> $GITHUB_OUTPUT
        
        echo "ðŸ“‹ Changed containers: ${changed_containers[*]}"
        echo "ðŸ—ï¸ Base images changed: $base_images_changed"
    
    - name: List all containers
      id: containers
      run: |
        echo "ðŸ“¦ Listing all available containers..."
        
        containers=()
        for dir in docker_instances/*/; do
          if [ -f "$dir/Dockerfile" ]; then
            container=$(basename "$dir")
            containers+=("$container")
          fi
        done
        
        printf -v joined '"%s",' "${containers[@]}"
        echo "all-containers=[${joined%,}]" >> $GITHUB_OUTPUT
        
        echo "ðŸ“‹ All containers: ${containers[*]}"

  build-base-images:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.base-images-changed == 'true' || needs.detect-changes.outputs.changed-containers != '[]'
    strategy:
      matrix:
        image: 
          - python_basic_crawler
          - python_selenium_crawler
          - php_basic_crawler
          - flask_monitor
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: network=host
    
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push base image ${{ matrix.image }}
      run: |
        echo "ðŸ—ï¸ Building and pushing base image ${{ matrix.image }} to GHCR..."
        cd base_images/${{ matrix.image }}
        
        # Build and push to GHCR for sharing between jobs
        docker buildx build \
          --platform linux/amd64 \
          --tag ghcr.io/${{ github.repository_owner }}/gs_crawler_${{ matrix.image }}:pr-${{ github.event.number || 'test' }} \
          --push \
          --cache-from=type=gha \
          --cache-to=type=gha,mode=max \
          .
        
        echo "âœ… Base image ${{ matrix.image }} built and pushed to GHCR successfully"

  test-container-builds:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-base-images]
    if: always() && (needs.detect-changes.outputs.changed-containers != '[]' || needs.detect-changes.outputs.base-images-changed == 'true')
    strategy:
      matrix:
        container: ${{ fromJson(needs.detect-changes.outputs.base-images-changed == 'true' && needs.detect-changes.outputs.all-containers || needs.detect-changes.outputs.changed-containers) }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: network=host
    
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Prepare base images
      run: |
        echo "ðŸ”§ Preparing base images for container ${{ matrix.container }}..."
        
        # Bestimme welches Base-Image benÃ¶tigt wird
        dockerfile="docker_instances/${{ matrix.container }}/Dockerfile"
        
        if [ ! -f "$dockerfile" ]; then
          echo "âŒ Dockerfile not found: $dockerfile"
          exit 1
        fi
        
        base_image=$(grep "^FROM" "$dockerfile" | head -1 | awk '{print $2}' | cut -d':' -f1)
        echo "ðŸ“¦ Base image needed: $base_image"
        
        # Map base image name to GHCR image name
        case "$base_image" in
          "gs_crawler/python_basic_crawler"|"stuffdev/python_basic_crawler")
            ghcr_image="ghcr.io/${{ github.repository_owner }}/gs_crawler_python_basic_crawler:pr-${{ github.event.number || 'test' }}"
            local_tag="gs_crawler/python_basic_crawler:test"
            base_image_dir="python_basic_crawler"
            ;;
          "gs_crawler/python_selenium_crawler"|"stuffdev/python_selenium_crawler")
            ghcr_image="ghcr.io/${{ github.repository_owner }}/gs_crawler_python_selenium_crawler:pr-${{ github.event.number || 'test' }}"
            local_tag="gs_crawler/python_selenium_crawler:test"
            base_image_dir="python_selenium_crawler"
            ;;
          "gs_crawler/php_basic_crawler"|"stuffdev/php_basic_crawler")
            ghcr_image="ghcr.io/${{ github.repository_owner }}/gs_crawler_php_basic_crawler:pr-${{ github.event.number || 'test' }}"
            local_tag="gs_crawler/php_basic_crawler:test"
            base_image_dir="php_basic_crawler"
            ;;
          "gs_crawler/flask_monitor"|"stuffdev/flask_monitor")
            ghcr_image="ghcr.io/${{ github.repository_owner }}/gs_crawler_flask_monitor:pr-${{ github.event.number || 'test' }}"
            local_tag="gs_crawler/flask_monitor:test"
            base_image_dir="flask_monitor"
            ;;
          *)
            echo "âŒ Unknown base image: $base_image"
            exit 1
            ;;
        esac
        
        # Try to pull from GHCR first (in case base images were built in build-base-images job)
        if docker pull "$ghcr_image" 2>/dev/null; then
          echo "âœ… Pulled base image from GHCR: $ghcr_image"
          docker tag "$ghcr_image" "$local_tag"
        else
          echo "â„¹ï¸ Base image not found in GHCR, building locally with cache..."
          cd "base_images/$base_image_dir"
          docker buildx build \
            --platform linux/amd64 \
            --tag "$local_tag" \
            --load \
            --cache-from=type=gha \
            --cache-to=type=gha,mode=max \
            .
          cd ../..
        fi
        
        echo "âœ… Base image prepared successfully: $local_tag"
    
    - name: Test build ${{ matrix.container }}
      run: |
        echo "ðŸ—ï¸ Testing build for container ${{ matrix.container }}..."
        cd docker_instances/${{ matrix.container }}
        
        # Ersetze Base-Image-Tags fÃ¼r Test
        sed 's/:latest/:test/g' Dockerfile > Dockerfile.test
        
        # Build Container mit Cache
        docker buildx build \
          --platform linux/amd64 \
          --file Dockerfile.test \
          --tag gs_crawler_test/${{ matrix.container }}:test \
          --load \
          --cache-from=type=gha \
          --cache-to=type=gha,mode=max \
          .
        
        echo "âœ… Build test successful for ${{ matrix.container }}"
    
    - name: Validate container functionality
      run: |
        echo "ðŸ§ª Testing container ${{ matrix.container }} functionality..."
        
        # Grundlegende Funktionstests
        container_type=$(basename $(dirname $(find docker_instances/${{ matrix.container }} -name "*.py" -o -name "*.php" | head -1)) 2>/dev/null || echo "unknown")
        
        case "${{ matrix.container }}" in
          "000_health_monitor")
            # Flask App Test
            echo "Testing Flask health monitor..."
            docker run --rm --name test_${{ matrix.container }} -d gs_crawler_test/${{ matrix.container }}:test
            sleep 3
            # PrÃ¼fe ob Container lÃ¤uft
            if docker ps | grep -q test_${{ matrix.container }}; then
              echo "âœ… Health monitor container started successfully"
              docker stop test_${{ matrix.container }} || true
            else
              echo "âŒ Health monitor container failed to start"
              docker logs test_${{ matrix.container }} || true
              exit 1
            fi
            ;;
          "002_ferienpass")
            # PHP Container Test
            echo "Testing PHP container..."
            docker run --rm gs_crawler_test/${{ matrix.container }}:test php --version
            docker run --rm gs_crawler_test/${{ matrix.container }}:test /bin/bash -c "ls -la /app"
            ;;
          *)
            # Python Container Test
            echo "Testing Python container..."
            docker run --rm gs_crawler_test/${{ matrix.container }}:test python3 --version
            docker run --rm gs_crawler_test/${{ matrix.container }}:test /bin/bash -c "ls -la /app/.venv/bin/python3"
            docker run --rm gs_crawler_test/${{ matrix.container }}:test /bin/bash -c "crontab -l || echo 'No crontab configured'"
            ;;
        esac
        
        echo "âœ… Functionality test passed for ${{ matrix.container }}"
    
    - name: Check container files
      run: |
        echo "ðŸ“‹ Checking required files for ${{ matrix.container }}..."
        
        cd docker_instances/${{ matrix.container }}
        required_files=("Dockerfile")
        
        # Container-spezifische Dateien
        case "${{ matrix.container }}" in
          "000_health_monitor")
            required_files+=("app.py" "templates")
            ;;
          "002_ferienpass")
            required_files+=("fepa_fetcher.php" "crontab")
            ;;
          *)
            required_files+=("crontab")
            # PrÃ¼fe auf Script-Dateien
            if [ -f "script.py" ]; then
              required_files+=("script.py")
            fi
            ;;
        esac
        
        for file in "${required_files[@]}"; do
          if [ -e "$file" ]; then
            echo "âœ… Found: $file"
          else
            echo "âŒ Missing: $file"
            exit 1
          fi
        done
        
        echo "âœ… All required files present for ${{ matrix.container }}"

  test-integration:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-base-images, test-container-builds]
    if: always() && needs.test-container-builds.result == 'success'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: network=host
    
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create test output directory
      run: |
        mkdir -p test_output
        echo "ðŸ“ Created test output directory"
    
    - name: Build subset of containers for integration test
      run: |
        echo "ðŸ”§ Building key containers for integration test..."
        
        # Use cached base images when available
        key_base_images=("python_basic_crawler" "flask_monitor")
        for image in "${key_base_images[@]}"; do
          if [ -d "base_images/$image" ]; then
            echo "Preparing base image: $image"
            
            # Try to pull from GHCR first
            ghcr_image="ghcr.io/${{ github.repository_owner }}/gs_crawler_$image:pr-${{ github.event.number || 'test' }}"
            local_tag="gs_crawler/$image:test"
            
            if docker pull "$ghcr_image" 2>/dev/null; then
              echo "âœ… Pulled base image from GHCR: $ghcr_image"
              docker tag "$ghcr_image" "$local_tag"
            else
              echo "â„¹ï¸ Base image not found in GHCR, building locally with cache..."
              cd "base_images/$image"
              docker buildx build \
                --platform linux/amd64 \
                --tag "$local_tag" \
                --load \
                --cache-from=type=gha \
                --cache-to=type=gha,mode=max \
                .
              cd ../..
            fi
          fi
        done
        
        # Baue Test-Container mit Cache
        key_containers=("000_health_monitor" "019_was_app" "001_senioren")
        for container in "${key_containers[@]}"; do
          if [ -d "docker_instances/$container" ]; then
            echo "Building container: $container"
            cd docker_instances/$container
            sed 's/:latest/:test/g' Dockerfile > Dockerfile.test
            docker buildx build \
              --platform linux/amd64 \
              --file Dockerfile.test \
              --tag gs_crawler_test/$container:test \
              --load \
              --cache-from=type=gha \
              --cache-to=type=gha,mode=max \
              .
            cd ../..
            echo "âœ… Built container with cache: $container"
          fi
        done
    
    - name: Test container interactions
      run: |
        echo "ðŸ§ª Testing container interactions..."
        
        # Starte Health Monitor
        docker run --rm --name test_health_monitor -d \
          -v $(pwd)/test_output:/app/output \
          -p 5555:5000 \
          gs_crawler_test/000_health_monitor:test
        
        sleep 5
        
        # Teste Health Monitor API
        if curl -f http://localhost:5555/api/health > /dev/null 2>&1; then
          echo "âœ… Health Monitor API accessible"
        else
          echo "âŒ Health Monitor API not accessible"
          docker logs test_health_monitor
          docker stop test_health_monitor || true
          exit 1
        fi
        
        # Cleanup
        docker stop test_health_monitor || true
        
        echo "âœ… Integration test completed successfully"

  security-scan:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-base-images, test-container-builds]
    if: always() && needs.test-container-builds.result == 'success'
    strategy:
      matrix:
        container: ${{ fromJson(needs.detect-changes.outputs.base-images-changed == 'true' && needs.detect-changes.outputs.all-containers || needs.detect-changes.outputs.changed-containers) }}
        exclude:
          - container: "[]"
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: 'docker_instances/${{ matrix.container }}'
        format: 'sarif'
        output: 'trivy-results-${{ matrix.container }}.sarif'
    
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results-${{ matrix.container }}.sarif'

  summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-base-images, test-container-builds, test-integration, security-scan]
    if: always()
    
    steps:
    - name: Test Summary
      run: |
        echo "# ðŸ§ª Container Instances Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.detect-changes.outputs.changed-containers }}" == "[]" ] && [ "${{ needs.detect-changes.outputs.base-images-changed }}" == "false" ]; then
          echo "â„¹ï¸ No containers or base images changed - no tests needed" >> $GITHUB_STEP_SUMMARY
          exit 0
        fi
        
        echo "## ðŸ“‹ Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Test Results
        if [ "${{ needs.test-container-builds.result }}" == "success" ]; then
          echo "âœ… **Container Builds:** All containers built successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Container Builds:** Some containers failed to build" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.test-integration.result }}" == "success" ]; then
          echo "âœ… **Integration Tests:** All tests passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Integration Tests:** Some tests failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.security-scan.result }}" == "success" ]; then
          echo "âœ… **Security Scan:** No critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Security Scan:** Check security tab for details" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Tested Containers" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.detect-changes.outputs.base-images-changed }}" == "true" ]; then
          echo "ðŸ”„ **All containers tested** (base images changed)" >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸ“‹ **Changed containers:** ${{ needs.detect-changes.outputs.changed-containers }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Overall Status
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.test-container-builds.result }}" == "success" ] && [ "${{ needs.test-integration.result }}" == "success" ]; then
          echo "ðŸŽ‰ **Overall Status:** All tests passed - ready for merge!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Overall Status:** Some tests failed - review required" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
